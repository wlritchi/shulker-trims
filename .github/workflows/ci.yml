name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  java_version: 21

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      attestations: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1

      - name: Set up Java ${{ env.java_version }}
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9  # v4.8.0
        with:
          java-version: ${{ env.java_version }}
          distribution: temurin

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@da187c8e6ffbd3802e00f2477aa5a822b25f2dda  # v4.4.4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Build all modules
        run: ./gradlew build

      - name: Run slow tests (game tests)
        run: ./gradlew slowTest

      - name: Attest universal JAR
        uses: actions/attest-build-provenance@e8998f949152b193b063cb0ec769d69d929409be  # v2.4.0
        with:
          subject-path: build/forgix/shulker-trims-*.jar

      - name: Upload Universal JAR
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: universal-jar
          path: build/forgix/shulker-trims-*.jar
          if-no-files-found: error

  fabric-runtime-test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1

      - name: Set up Java ${{ env.java_version }}
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9  # v4.8.0
        with:
          java-version: ${{ env.java_version }}
          distribution: temurin

      - name: Download universal JAR
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4.3.0
        with:
          name: universal-jar
          path: run/mods

      - name: Run Minecraft runtime test
        uses: headlesshq/mc-runtime-test@2a5a5bcc9d833cf22a817f3561915421dfd6a287  # 4.1.0
        with:
          mc: 1.21.10
          modloader: fabric
          regex: .*fabric.*
          mc-runtime-test: fabric
          java: ${{ env.java_version }}
          cache-mc: github
          fabric-api: 0.138.4

  paper-runtime-test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1

      - name: Set up Java ${{ env.java_version }}
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9  # v4.8.0
        with:
          java-version: ${{ env.java_version }}
          distribution: temurin

      - name: Download universal JAR
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4.3.0
        with:
          name: universal-jar
          path: plugin

      - name: Run Paper runtime test
        run: |
          PLUGIN_JAR=$(ls plugin/*.jar | head -1)
          .github/scripts/paper-runtime-test.sh "$PLUGIN_JAR" 1.21.10

  fabric-client-gametest:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1

      - name: Set up Java ${{ env.java_version }}
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9  # v4.8.0
        with:
          java-version: ${{ env.java_version }}
          distribution: temurin

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@da187c8e6ffbd3802e00f2477aa5a822b25f2dda  # v4.4.4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Install XVFB
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Run client gametest with XVFB
        run: xvfb-run -a ./gradlew :fabric:runClientGameTest

      - name: Upload test screenshots
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        if: always()
        with:
          name: client-gametest-screenshots
          path: |
            fabric/build/run/clientGameTest/screenshots
            build/run/clientGameTest/screenshots
          if-no-files-found: warn

      # Upload generated templates when they don't exist yet (for initial setup)
      # When templates are missing, Fabric saves screenshots to the templates directory
      # These can be downloaded and committed to the repository
      - name: Upload generated templates (if any)
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        if: always()
        with:
          name: generated-templates
          path: fabric/src/gametest/resources/templates/*.png
          if-no-files-found: ignore

      - name: Store test reports on failure
        if: failure()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: client-gametest-reports
          path: |
            **/build/reports/
            **/build/test-results/
            fabric/build/run/clientGameTest/logs
