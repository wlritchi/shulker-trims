name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  java_version: 21

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java ${{ env.java_version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.java_version }}
          distribution: temurin

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Build all modules
        run: ./gradlew build

      - name: Upload Fabric JAR
        uses: actions/upload-artifact@v4
        with:
          name: fabric-mod
          path: fabric/build/libs/shulker-trims-mc1.21.10-fabric-*.jar
          if-no-files-found: error

      - name: Upload Bukkit JAR
        uses: actions/upload-artifact@v4
        with:
          name: bukkit-plugin
          path: bukkit/build/libs/shulker-trims-mc1.21.10-bukkit-*.jar
          if-no-files-found: error

      - name: Upload Universal JAR
        uses: actions/upload-artifact@v4
        with:
          name: universal-jar
          path: build/forgix/shulker-trims-*.jar
          if-no-files-found: error

  fabric-runtime-test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java ${{ env.java_version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.java_version }}
          distribution: temurin

      - name: Download Fabric mod artifact
        uses: actions/download-artifact@v4
        with:
          name: fabric-mod
          path: run/mods

      - name: Run Minecraft runtime test
        uses: headlesshq/mc-runtime-test@4.1.0
        with:
          mc: 1.21.10
          modloader: fabric
          regex: .*fabric.*
          mc-runtime-test: fabric
          java: ${{ env.java_version }}
          cache-mc: github

  paper-runtime-test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java ${{ env.java_version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.java_version }}
          distribution: temurin

      - name: Download Bukkit plugin artifact
        uses: actions/download-artifact@v4
        with:
          name: bukkit-plugin
          path: plugin

      - name: Run Paper runtime test
        run: |
          PLUGIN_JAR=$(ls plugin/*.jar | head -1)
          .github/scripts/paper-runtime-test.sh "$PLUGIN_JAR" 1.21.10

  fabric-client-gametest:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java ${{ env.java_version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.java_version }}
          distribution: temurin

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Install XVFB
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Run production client gametest
        run: ./gradlew :fabric:runProductionClientGameTest

      - name: Upload test screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: client-gametest-screenshots
          path: |
            fabric/build/run/clientGameTest/screenshots
            build/run/clientGameTest/screenshots
          if-no-files-found: warn

      - name: Store test reports on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: client-gametest-reports
          path: |
            **/build/reports/
            **/build/test-results/
            fabric/build/run/clientGameTest/logs
